<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Yeetmedia3.Views.GoogleDriveView"
             Title="Google Drive">

    <Grid RowDefinitions="Auto,Auto,*,Auto" Padding="10">

        <!-- Authentication Section -->
        <VerticalStackLayout Grid.Row="0" Spacing="10">
            <Button Text="Sign In to Google Drive"
                    Command="{Binding AuthenticateCommand}"
                    IsVisible="{Binding IsAuthenticated, Converter={StaticResource InverseBoolConverter}}"
                    BackgroundColor="#4285F4"
                    TextColor="White"
                    HeightRequest="44"/>

            <HorizontalStackLayout IsVisible="{Binding IsAuthenticated}" Spacing="10">
                <Label Text="Signed In"
                       TextColor="Green"
                       VerticalOptions="Center"
                       FontAttributes="Bold"/>
                <Button Text="Sign Out"
                        Command="{Binding SignOutCommand}"
                        BackgroundColor="#DC3545"
                        TextColor="White"
                        WidthRequest="100"/>
            </HorizontalStackLayout>
        </VerticalStackLayout>

        <!-- Search and Actions Bar -->
        <Grid Grid.Row="1"
              ColumnDefinitions="*,Auto,Auto,Auto"
              ColumnSpacing="5"
              Margin="0,10"
              IsVisible="{Binding IsAuthenticated}">

            <SearchBar x:Name="SearchBar"
                       Grid.Column="0"
                       Placeholder="Search files..."
                       SearchCommand="{Binding SearchFilesCommand}"
                       SearchCommandParameter="{Binding Source={x:Reference SearchBar}, Path=Text}"/>

            <Button Grid.Column="1"
                    Text="All Files"
                    Command="{Binding RefreshFilesCommand}"
                    BackgroundColor="#6C757D"
                    TextColor="White"
                    Padding="10,0"/>

            <Button Grid.Column="2"
                    Text="Folders"
                    Command="{Binding LoadFoldersCommand}"
                    BackgroundColor="#6C757D"
                    TextColor="White"
                    Padding="10,0"/>

            <Button Grid.Column="3"
                    Text="Refresh"
                    Command="{Binding RefreshFilesCommand}"
                    BackgroundColor="#28A745"
                    TextColor="White"
                    Padding="10,0"/>
        </Grid>

        <!-- Files List -->
        <RefreshView Grid.Row="2"
                     IsRefreshing="{Binding IsLoading}"
                     Command="{Binding RefreshFilesCommand}"
                     IsVisible="{Binding IsAuthenticated}">
            <CollectionView ItemsSource="{Binding Files}"
                            SelectedItem="{Binding SelectedFile}"
                            SelectionMode="Single">
                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="10">
                        <Image Source="dotnet_bot.png"
                               HeightRequest="100"
                               Aspect="AspectFit"
                               Opacity="0.5"/>
                        <Label Text="No files found"
                               HorizontalOptions="Center"
                               TextColor="Gray"
                               FontSize="16"/>
                        <Label Text="Sign in and refresh to see your files"
                               HorizontalOptions="Center"
                               TextColor="LightGray"
                               FontSize="12"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Padding="10"
                               Margin="5"
                               BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#2A2A2A}"
                               BorderColor="{AppThemeBinding Light=#DEE2E6, Dark=#444444}"
                               CornerRadius="5">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer NumberOfTapsRequired="2"
                                                      Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DownloadFileCommand}"
                                                      CommandParameter="{Binding .}"/>
                            </Frame.GestureRecognizers>

                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                                <!-- File Icon -->
                                <Label Grid.Column="0"
                                       Text="{Binding MimeType, Converter={StaticResource MimeTypeToIconConverter}}"
                                       FontFamily="FontAwesome"
                                       FontSize="24"
                                       VerticalOptions="Center"/>

                                <!-- File Details -->
                                <VerticalStackLayout Grid.Column="1" Spacing="2">
                                    <Label Text="{Binding Name}"
                                           FontAttributes="Bold"
                                           LineBreakMode="TailTruncation"/>
                                    <Label Text="{Binding MimeType}"
                                           FontSize="12"
                                           TextColor="Gray"
                                           LineBreakMode="TailTruncation"/>
                                    <Label FontSize="11"
                                           TextColor="DarkGray">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="Modified: "/>
                                                <Span Text="{Binding ModifiedTime, StringFormat='{0:MMM dd, yyyy}'}"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </VerticalStackLayout>

                                <!-- File Size -->
                                <Label Grid.Column="2"
                                       Text="{Binding Size, Converter={StaticResource FileSizeConverter}}"
                                       FontSize="12"
                                       TextColor="Gray"
                                       VerticalOptions="Center"/>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="2"
                           IsRunning="{Binding IsLoading}"
                           IsVisible="{Binding IsLoading}"
                           Color="#4285F4"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           WidthRequest="50"
                           HeightRequest="50"/>

        <!-- Error Message -->
        <Frame Grid.Row="3"
               IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
               BackgroundColor="#F8D7DA"
               BorderColor="#F5C6CB"
               Padding="10"
               Margin="0,5">
            <Label Text="{Binding ErrorMessage}"
                   TextColor="#721C24"
                   FontSize="14"/>
        </Frame>

    </Grid>

</ContentPage>