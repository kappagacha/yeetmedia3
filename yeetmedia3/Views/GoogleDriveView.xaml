<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Yeetmedia3.ViewModels"
             xmlns:googleapi="clr-namespace:Google.Apis.Drive.v3.Data;assembly=Google.Apis.Drive.v3"
             x:Class="Yeetmedia3.Views.GoogleDriveView"
             x:DataType="viewmodels:GoogleDriveViewModel"
             Title="Google Drive">

    <Grid RowDefinitions="Auto,Auto,Auto,*,Auto" Padding="10">

        <!-- Authentication Section -->
        <VerticalStackLayout Grid.Row="0" Spacing="10">
            <Button Text="Sign In to Google Drive"
                    Command="{Binding AuthenticateCommand}"
                    IsVisible="{Binding IsAuthenticated, Converter={StaticResource InverseBoolConverter}}"
                    BackgroundColor="#4285F4"
                    TextColor="White"
                    HeightRequest="44"/>

            <HorizontalStackLayout IsVisible="{Binding IsAuthenticated}" Spacing="10">
                <Label Text="Signed In"
                       TextColor="Green"
                       VerticalOptions="Center"
                       FontAttributes="Bold"/>
                <Button Text="Sign Out"
                        Command="{Binding SignOutCommand}"
                        BackgroundColor="#DC3545"
                        TextColor="White"
                        WidthRequest="100"/>
            </HorizontalStackLayout>
        </VerticalStackLayout>

        <!-- Navigation Bar -->
        <Grid Grid.Row="1"
              ColumnDefinitions="Auto,*,Auto,Auto,Auto,Auto,Auto"
              ColumnSpacing="5"
              Margin="0,10"
              IsVisible="{Binding IsAuthenticated}">

            <Button Grid.Column="0"
                    Text="â† Back"
                    Command="{Binding GoBackCommand}"
                    IsEnabled="{Binding CanGoBack}"
                    BackgroundColor="#007BFF"
                    TextColor="White"
                    Padding="10,5"/>

            <Label Grid.Column="1"
                   Text="{Binding CurrentFolderName}"
                   FontAttributes="Bold"
                   FontSize="16"
                   VerticalOptions="Center"
                   HorizontalOptions="Center"/>

            <Button Grid.Column="2"
                    Text="+ JSON"
                    Clicked="OnNewJsonButtonClicked"
                    BackgroundColor="#6F42C1"
                    TextColor="White"
                    Padding="10,5"/>

            <Button Grid.Column="3"
                    Text="Edit"
                    Command="{Binding EditJsonFileCommand}"
                    CommandParameter="{Binding SelectedFile}"
                    BackgroundColor="#FD7E14"
                    TextColor="White"
                    Padding="10,5"/>

            <Button Grid.Column="4"
                    Text="Copy"
                    Command="{Binding CopyFileContentsCommand}"
                    CommandParameter="{Binding SelectedFile}"
                    BackgroundColor="#17A2B8"
                    TextColor="White"
                    Padding="10,5"/>

            <Button Grid.Column="5"
                    Text="Delete"
                    Command="{Binding DeleteFileCommand}"
                    CommandParameter="{Binding SelectedFile}"
                    BackgroundColor="#DC3545"
                    TextColor="White"
                    Padding="10,5"/>

            <Button Grid.Column="6"
                    Text="Refresh"
                    Command="{Binding RefreshFilesCommand}"
                    BackgroundColor="#28A745"
                    TextColor="White"
                    Padding="10,5"/>
        </Grid>

        <!-- Search and Actions Bar -->
        <Grid Grid.Row="2"
              ColumnDefinitions="*,Auto,Auto,Auto"
              ColumnSpacing="5"
              Margin="0,10"
              IsVisible="{Binding IsAuthenticated}">

            <Entry x:Name="SearchEntry"
                   Grid.Column="0"
                   Placeholder="Search files..."
                   ReturnType="Search"
                   ReturnCommand="{Binding SearchFilesCommand}"
                   ReturnCommandParameter="{Binding Source={x:Reference SearchEntry}, Path=Text, x:DataType=Entry}"
                   BackgroundColor="{AppThemeBinding Light=White, Dark=#2A2A2A}"
                   PlaceholderColor="Gray"/>

            <Button Grid.Column="1"
                    Text="Search"
                    Command="{Binding SearchFilesCommand}"
                    CommandParameter="{Binding Source={x:Reference SearchEntry}, Path=Text, x:DataType=Entry}"
                    BackgroundColor="#007BFF"
                    TextColor="White"
                    Padding="10,0"/>

            <Button Grid.Column="2"
                    Text="All Files"
                    Command="{Binding RefreshFilesCommand}"
                    BackgroundColor="#6C757D"
                    TextColor="White"
                    Padding="10,0"/>

            <Button Grid.Column="3"
                    Text="Folders"
                    Command="{Binding LoadFoldersCommand}"
                    BackgroundColor="#6C757D"
                    TextColor="White"
                    Padding="10,0"/>
        </Grid>

        <!-- Files List -->
        <RefreshView Grid.Row="3"
                     IsRefreshing="{Binding IsLoading}"
                     Command="{Binding RefreshFilesCommand}"
                     IsVisible="{Binding IsAuthenticated}">
            <CollectionView ItemsSource="{Binding Files}"
                            SelectedItem="{Binding SelectedFile}"
                            SelectionMode="Single"
                            SelectionChanged="OnSelectionChanged">
                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="10">
                        <Image Source="dotnet_bot.png"
                               HeightRequest="100"
                               Aspect="AspectFit"
                               Opacity="0.5"/>
                        <Label Text="No files found"
                               HorizontalOptions="Center"
                               TextColor="Gray"
                               FontSize="16"/>
                        <Label Text="Sign in and refresh to see your files"
                               HorizontalOptions="Center"
                               TextColor="LightGray"
                               FontSize="12"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="googleapi:File">
                        <Border Padding="10"
                                Margin="5"
                                Stroke="{AppThemeBinding Light=#DEE2E6, Dark=#444444}"
                                StrokeThickness="2"
                                StrokeShape="RoundRectangle 5">
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup Name="CommonStates">
                                    <VisualState Name="Normal">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#F8F9FA, Dark=#2A2A2A}" />
                                        </VisualState.Setters>
                                    </VisualState>
                                    <VisualState Name="Selected">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#E3F2FD, Dark=#1565C0}" />
                                            <Setter Property="Stroke" Value="#2196F3" />
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer NumberOfTapsRequired="1"
                                                      Tapped="OnItemTapped"/>
                                <TapGestureRecognizer NumberOfTapsRequired="2"
                                                      Tapped="OnItemDoubleTapped"/>
                            </Border.GestureRecognizers>

                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                                <!-- File Icon -->
                                <Label Grid.Column="0"
                                       Text="{Binding MimeType, Converter={StaticResource MimeTypeToIconConverter}}"
                                       FontFamily="FontAwesome"
                                       FontSize="24"
                                       VerticalOptions="Center"/>

                                <!-- File Details -->
                                <VerticalStackLayout Grid.Column="1" Spacing="2">
                                    <Label Text="{Binding Name}"
                                           FontAttributes="Bold"
                                           LineBreakMode="TailTruncation"/>
                                    <Label Text="{Binding MimeType}"
                                           FontSize="12"
                                           TextColor="Gray"
                                           LineBreakMode="TailTruncation"/>
                                    <Label FontSize="11"
                                           TextColor="DarkGray">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="Modified: "/>
                                                <Span Text="{Binding ModifiedTimeDateTimeOffset, StringFormat='{0:MMM dd, yyyy}'}"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </VerticalStackLayout>

                                <!-- File Size -->
                                <Label Grid.Column="2"
                                       Text="{Binding Size, Converter={StaticResource FileSizeConverter}}"
                                       FontSize="12"
                                       TextColor="Gray"
                                       VerticalOptions="Center"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="3"
                           IsRunning="{Binding IsLoading}"
                           IsVisible="{Binding IsLoading}"
                           Color="#4285F4"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           WidthRequest="50"
                           HeightRequest="50"/>

        <!-- Error Message -->
        <Border Grid.Row="4"
                IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
                BackgroundColor="#F8D7DA"
                Stroke="#F5C6CB"
                StrokeThickness="1"
                Padding="10"
                Margin="0,5">
            <Label Text="{Binding ErrorMessage}"
                   TextColor="#721C24"
                   FontSize="14"/>
        </Border>

    </Grid>

</ContentPage>