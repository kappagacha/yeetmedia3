<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:viewmodels="clr-namespace:Yeetmedia3.ViewModels"
             x:Class="Yeetmedia3.Views.DotnetRocksView"
             x:DataType="viewmodels:DotnetRocksViewModel"
             Title=".NET Rocks! Podcast">

    <Grid RowDefinitions="Auto,Auto,Auto,Auto,*,Auto" Padding="10">

        <!-- Header -->
        <Label Grid.Row="0"
               Text=".NET Rocks! Podcast"
               FontSize="24"
               FontAttributes="Bold"
               HorizontalOptions="Center"
               TextColor="{AppThemeBinding Light=#512BD4, Dark=#9D71FF}"
               Margin="0,0,0,10"/>

        <!-- Episode Input and Action Buttons Row -->
        <Grid Grid.Row="1"
              ColumnDefinitions="Auto,*,Auto,Auto"
              ColumnSpacing="5"
              Margin="0,0,0,10">

            <!-- Decrement Button -->
            <Button Grid.Column="0"
                    Text="−"
                    Command="{Binding DecrementEpisodeCommand}"
                    FontSize="20"
                    WidthRequest="40"
                    HeightRequest="40"
                    CornerRadius="20"
                    BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                    TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"/>

            <!-- Episode Number Input -->
            <Entry Grid.Column="1"
                   x:Name="EpisodeNumberEntry"
                   Text="{Binding EpisodeNumber}"
                   Placeholder="Episode #"
                   Keyboard="Numeric"
                   FontSize="16"
                   HorizontalTextAlignment="Center"
                   VerticalOptions="Center"
                   BackgroundColor="{AppThemeBinding Light=#F8F8F8, Dark=#2A2A2A}"/>

            <!-- Increment Button -->
            <Button Grid.Column="2"
                    Text="+"
                    Command="{Binding IncrementEpisodeCommand}"
                    FontSize="20"
                    WidthRequest="40"
                    HeightRequest="40"
                    CornerRadius="20"
                    BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                    TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"/>

            <!-- Actions Button -->
            <Button Grid.Column="3"
                    Text="⋮"
                    Command="{Binding ShowActionsCommand}"
                    BackgroundColor="{AppThemeBinding Light=#6C757D, Dark=#5A6268}"
                    TextColor="White"
                    WidthRequest="44"
                    HeightRequest="44"
                    CornerRadius="22"
                    FontSize="20"
                    ToolTipProperties.Text="More Actions"/>
        </Grid>

        <!-- Sleep Timer Row -->
        <HorizontalStackLayout Grid.Row="2"
                               Spacing="5"
                               Margin="0,0,0,10"
                               HorizontalOptions="Center">
            <Label Text="Sleep Timer:"
                   VerticalOptions="Center"
                   FontSize="14"/>

            <Picker x:Name="SleepTimerPicker"
                    SelectedIndex="{Binding SleepTimerMinutes}"
                    FontSize="14"
                    WidthRequest="80">
                <Picker.Items>
                    <x:String>Off</x:String>
                    <x:String>5 min</x:String>
                    <x:String>10 min</x:String>
                    <x:String>15 min</x:String>
                    <x:String>30 min</x:String>
                    <x:String>45 min</x:String>
                    <x:String>60 min</x:String>
                </Picker.Items>
            </Picker>

            <Button Text="Start"
                    Command="{Binding StartSleepTimerCommand}"
                    BackgroundColor="{AppThemeBinding Light=#28A745, Dark=#20C940}"
                    TextColor="White"
                    FontSize="14"
                    Padding="10,5"
                    IsVisible="{Binding IsSleepTimerRunning, Converter={StaticResource InverseBoolConverter}}"/>

            <Button Text="Stop"
                    Command="{Binding StopSleepTimerCommand}"
                    BackgroundColor="{AppThemeBinding Light=#DC3545, Dark=#C82333}"
                    TextColor="White"
                    FontSize="14"
                    Padding="10,5"
                    IsVisible="{Binding IsSleepTimerRunning}"/>

            <Label Text="{Binding SleepTimerDisplay}"
                   VerticalOptions="Center"
                   FontSize="14"
                   FontAttributes="Bold"
                   TextColor="{AppThemeBinding Light=#512BD4, Dark=#9D71FF}"
                   IsVisible="{Binding IsSleepTimerRunning}"/>
        </HorizontalStackLayout>

        <!-- Episode Info Section -->
        <Border Grid.Row="3"
                BackgroundColor="{AppThemeBinding Light=#F0F8FF, Dark=#1A2332}"
                Stroke="{AppThemeBinding Light=#B0D4FF, Dark=#2E4E7E}"
                StrokeThickness="1"
                Padding="10"
                Margin="0,0,0,8"
                IsVisible="{Binding EpisodeTitle, Converter={StaticResource StringToBoolConverter}}">

            <VerticalStackLayout Spacing="5">
                <Label Text="{Binding EpisodeTitle}"
                       FontSize="16"
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                       LineBreakMode="WordWrap"/>

                <Label Text="{Binding EpisodeDescription}"
                       FontSize="13"
                       TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}"
                       LineBreakMode="WordWrap"
                       MaxLines="2"/>

                <HorizontalStackLayout Spacing="15">
                    <Label FontSize="12"
                           TextColor="Gray">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span Text="Published: "/>
                                <Span Text="{Binding EpisodePublishDate, StringFormat='{0:MMM dd, yyyy}'}"
                                      FontAttributes="Bold"/>
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>

                    <Label Text="✓ Cached"
                           FontSize="12"
                           TextColor="Green"
                           FontAttributes="Bold"
                           IsVisible="{Binding IsEpisodeCached}"/>
                </HorizontalStackLayout>
            </VerticalStackLayout>
        </Border>

        <!-- MediaElement for audio/video playback -->
        <toolkit:MediaElement x:Name="MediaPlayer"
                              Grid.Row="4"
                              IsVisible="{Binding IsEpisodeCached}"
                              ShouldAutoPlay="False"
                              ShouldShowPlaybackControls="True"
                              VerticalOptions="Fill"
                              HorizontalOptions="Fill"
                              BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#1E1E1E}"
                              Margin="0,5,0,5" />

        <!-- Download Button when no episode is cached -->
        <Button Grid.Row="4"
                IsVisible="{Binding IsEpisodeCached, Converter={StaticResource InverseBoolConverter}}"
                Text="⬇"
                Command="{Binding PlayEpisodeCommand}"
                BackgroundColor="{AppThemeBinding Light=#28A745, Dark=#20C940}"
                TextColor="White"
                WidthRequest="80"
                HeightRequest="80"
                CornerRadius="40"
                FontSize="40"
                VerticalOptions="Center"
                HorizontalOptions="Center"
                ToolTipProperties.Text="Download and Play Episode"/>

        <!-- Status/Loading Section with Progress Bar Background -->
        <Border Grid.Row="5"
                BackgroundColor="{AppThemeBinding Light=#FFF9E6, Dark=#3A3A2A}"
                Stroke="{AppThemeBinding Light=#FFE4B5, Dark=#5A5A3A}"
                StrokeThickness="1"
                Padding="0"
                Margin="0,8,0,0">
            <Grid>
                <!-- Progress bar in background -->
                <ProgressBar Progress="{Binding DownloadProgress}"
                             VerticalOptions="Fill"
                             HorizontalOptions="Fill"
                             ProgressColor="{AppThemeBinding Light=#FFE4B580, Dark=#5A5A3A80}"
                             BackgroundColor="Transparent"
                             IsVisible="{Binding IsBusy}"/>

                <!-- Status content on top -->
                <HorizontalStackLayout Spacing="10"
                                       Padding="10"
                                       BackgroundColor="Transparent">
                    <ActivityIndicator IsRunning="{Binding IsBusy}"
                                       IsVisible="{Binding IsBusy}"
                                       Color="#4285F4"
                                       WidthRequest="20"
                                       HeightRequest="20"/>

                    <Label Text="{Binding StatusMessage}"
                           VerticalOptions="Center"
                           FontSize="14"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}"/>
                </HorizontalStackLayout>
            </Grid>
        </Border>

    </Grid>

</ContentPage>